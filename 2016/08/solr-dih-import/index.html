<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="baidu-site-verification" content="20aAL2tUWx" /><meta name="google-site-verification" content="An2eGWQakKFcIZ1YuwZSilNuSYlfHs1zH0Hr-OMW6oQ" /><title>solr-dih增量与全量导入配置详解</title><meta name="description" content=""><meta name="keywords" content="solr,DataImportHandler,dih"><link rel="icon" href="/assets/favicon.ico"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2016/08/solr-dih-import/"><link rel="alternate" type="application/atom+xml" title="Vinny's Blog - 王俊博客 - 交流软件领域知识 | 纪录点滴精彩人生" href="/feed.xml" /></head><body><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> / <a class="page-link" href="/about/">ABOUT</a></nav><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>solr-dih增量与全量导入配置详解</h1><time>2016-08-02</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#section" id="markdown-toc-section">1. 背景简介</a></li><li><a href="#section-1" id="markdown-toc-section-1">2. 前提条件</a></li><li><a href="#section-2" id="markdown-toc-section-2">3. 配置步骤</a><ul><li><a href="#section-3" id="markdown-toc-section-3">3.1 配置依赖管理</a></li><li><a href="#dih-" id="markdown-toc-dih-">3.2 添加 DIH 处理器</a></li><li><a href="#db-data-configxml" id="markdown-toc-db-data-configxml">3.3 创建 db-data-config.xml</a></li><li><a href="#schemaxml-" id="markdown-toc-schemaxml-">3.4 编辑 schema.xml 文件</a></li></ul></li><li><a href="#section-4" id="markdown-toc-section-4">4. 启动验证</a></li><li><a href="#a" id="markdown-toc-a">附录 A</a></li><li><a href="#b" id="markdown-toc-b">附录 B</a></li><li><a href="#c" id="markdown-toc-c">附录 C</a></li></ul><h2 id="section">1. 背景简介</h2><p><strong>solr</strong> 对于数据的索引常常使用 solrj 或者 dih（DataImportHandler） 的方式索引数据，本篇文章将详细说明如何使用 DIH 的方式进行数据库数据索引的配置操作。</p><h2 id="section-1">2. 前提条件</h2><ol><li>使用的是solr5.3.1版本</li><li>由于使用的是solr5的版本，所以jdk需要1.7或者以上的版本</li><li>准备好mysql数据库及其测试数据</li></ol><h2 id="section-2">3. 配置步骤</h2><h3 id="section-3">3.1 配置依赖管理</h3><p>在 <strong>$SOLR_HOME/dist</strong> 目录中找到 solr-dataimporthandler-5.3.1.jar 和 solr-dataimporthandler-extras-5.3.1.jar两个文件，拷贝到 <strong>$SOLR_HOME/server/solr-webapp/webapp/WEB-INF/lib</strong> 目录中，数据库驱动文件，如mysql的 mysql-connector-java-5.1.18-bin.jar 也需要拷贝。</p><h3 id="dih-">3.2 添加 DIH 处理器</h3><p>编辑 <strong>solrconfig.xml</strong> 文件，添加 DIH 处理器和数据库相关配置</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;requestHandler</span> <span class="na">name=</span><span class="s">"/dataimport"</span> <span class="na">class=</span><span class="s">"org.apache.solr.handler.dataimport.DataImportHandler"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">"defaults"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"config"</span><span class="nt">&gt;</span>db-data-config.xml<span class="nt">&lt;/str&gt;</span>
        <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">"datasource"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"driver"</span><span class="nt">&gt;</span>com.mysql.jdbc.Driver<span class="nt">&lt;/str&gt;</span>
            <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"url"</span><span class="nt">&gt;</span>jdbc:mysql://127.0.0.1:3306/solr<span class="nt">&lt;/str&gt;</span>
            <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"user"</span><span class="nt">&gt;</span>root<span class="nt">&lt;/str&gt;</span>
            <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>root<span class="nt">&lt;/str&gt;</span>
        <span class="nt">&lt;/lst&gt;</span>
    <span class="nt">&lt;/lst&gt;</span>
<span class="nt">&lt;/requestHandler&gt;</span>
</code></pre></div><h3 id="db-data-configxml">3.3 创建 db-data-config.xml</h3><p>在 <strong>$SOLR_HOME//server/solr/{CORE_NAME}/conf</strong> 目录中创建 db-data-config.xml 文件，db-data-config.xml 文件是配置数据库连接信息以及具体的增量与全量导入的规则。</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dataConfig&gt;</span>
    <span class="c">&lt;!-- &lt;dataSource driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost:3306/solr" user="root" password="root"/&gt; --&gt;</span>
    <span class="nt">&lt;document&gt;</span>
        <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"product"</span> <span class="na">query=</span><span class="s">"select * from product"</span>
            <span class="na">deltaQuery=</span><span class="s">"select product_id from product where create_time &gt; '${dataimporter.last_index_time}'"</span>
            <span class="na">deltaImportQuery=</span><span class="s">"select * from product where product_id = '${dih.delta.product_id}'"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">"product_id"</span> <span class="na">name=</span><span class="s">"productId"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">"product_name"</span> <span class="na">name=</span><span class="s">"productName"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">"product_price"</span> <span class="na">name=</span><span class="s">"productPrice"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">"product_code"</span> <span class="na">name=</span><span class="s">"productCode"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">"create_time"</span> <span class="na">name=</span><span class="s">"createTime"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/entity&gt;</span>
    <span class="nt">&lt;/document&gt;</span>
<span class="nt">&lt;/dataConfig&gt;</span>
</code></pre></div><h3 id="schemaxml-">3.4 编辑 schema.xml 文件</h3><p>schema.xml 文件主要定义索引字段的类型与存储结构，其中字段应与在 db-data-config.xml 中查询的一致。这里需要注意的是在下面的 productName 字段，这里配置的是 text_ik 类型，text_ik 类型是用于中文分词的，若还未涉及到中文分词，这里可以给其string类型即可。</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productId"</span> <span class="na">type=</span><span class="s">"int"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productName"</span> <span class="na">type=</span><span class="s">"text_ik"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="na">termVectors=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productPrice"</span> <span class="na">type=</span><span class="s">"float"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productCode"</span> <span class="na">type=</span><span class="s">"string"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="na">termVectors=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"createTime"</span> <span class="na">type=</span><span class="s">"date"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
</code></pre></div><h2 id="section-4">4. 启动验证</h2><p>启动好 solr 后可以进入对应 core 的 DataImport 界面，点击 execute 完成导入操作。</p><p><strong>浏览器方式执行</strong></p><div class="highlighter-rouge"><pre class="highlight"><code>http://localhost:8080/solr/dataimport?command=full-import           全量导入
http://localhost:8080/solr/dataimport?command=status                查看导入状态
http://localhost:8080/solr/dataimport?command=reload-config         刷新DIH配置
http://localhost:8080/solr/dataimport?command=abort                 终止正在进行的导入
</code></pre></div><hr /><h2 id="a">附录 A</h2><p>全量索引的代价过大，一般初全量始化后使用的是增量索引。<br /> 如果需要对某个模型进行增量索引，则该模型必须具有更新时间的字段，如updatetime，类型为timestamp。此字段用于维护纪录的更新时间。</p><p>有了更新的时间字段，solr才可以判断哪些数据是最新的。<br /> solr本身有一个默认值last_index_time，纪录的是最后一次full import或者delta import的时间，这个值存储在dataimport.properties文件中。<br /> solr使用last_index_time与数据库模型里的updatetime进行比较，在last_index_time之后的数据是需要增量索引的，具体可以看如下两行：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">"product"</span> <span class="na">query=</span><span class="s">"select * from product"</span>
    <span class="na">deltaQuery=</span><span class="s">"select product_id from product where update_time &gt; '${dataimporter.last_index_time}'"</span>
    <span class="na">deltaImportQuery=</span><span class="s">"select * from product where product_id = '${dih.delta.product_id}'"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">"product_id"</span> <span class="na">name=</span><span class="s">"productId"</span> <span class="nt">/&gt;</span>
    ......
<span class="nt">&lt;/entity&gt;</span>
</code></pre></div><p>增量索引必知的几个关键字含义：</p><p>deltaQuery 增量索引查询主键ID 注意这个只能返回ID字段<br /> deltaImportQuery 增量索引查询导入的数据<br /> deletedPkQuery 增量索引删除主键ID查询 注意这个只能返回ID字段</p><p>从上面的描述再结合配置可知，首先从deltaQuery指定的sql查询出需要增量导入的id，然后根据deltaImportQuery指定的sql语句返回这些id的数据。<br /> 核心的思想是：通过内置变量${dih.delta.id}和${dataimporter.last_index_time}来纪录本次要索引的id和最后一次索引时间</p><h2 id="b">附录 B</h2><p>定时索引可以使用curl、wget结合corn的方式做到。但solr官方也有其定时的实现，详细文档请参考 http://wiki.apache.org/solr/DataImportHandler#Scheduling，下面将说明下如何使用solr自带的定时索引功能。</p><p>首先需要准备好定时的相关依赖库，可以在 http://code.google.com/p/solr-data-import-scheduler/ 里下载，不能翻墙的请点击直接下载。下载好之后放到 $SOLR_HOME/server/solr-webapp/webapp/WEB-INF/lib 目录中。</p><p>在web.xml中添加监听器，编辑 $SOLR_HOME/server/solr-webapp/webapp/WEB-INF/web.xml 文件，在其中添加如下监听配置：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;listener&gt;</span>
    <span class="nt">&lt;listener-class&gt;</span>org.apache.solr.handler.dataimport.scheduler.ApplicationListener<span class="nt">&lt;/listener-class&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</code></pre></div><p>在 $SOLR_HOME/server/solr 目录新建一个文件夹conf，这里的conf并不是core里的conf目录，应该是一个全局的调度配置目录。创建好之后在里面创建一个 dataimport.properties 文件用于配置具体的调度信息。里面的内容可以参考solr wiki上的，之前下载的jar包里也存在此文件，可以使用压缩工具打开，直接拷贝到 $SOLR_HOME/server/solr/conf 目录。具体的配置内容如下：</p><div class="highlighter-rouge"><pre class="highlight"><code>#################################################
#                                               #
#       dataimport scheduler properties         #
#                                               #
#################################################

#  是否启用定时同步，1是启用，非1是禁用
syncEnabled=1

# 指定哪个core需要使用此规则，可以配置多个用逗号分隔
syncCores=core

#  solr服务器的ip地址或者域名，如果为空则缺省使用localhost
server=localhost

#  solr服务器的端口号，若为空则缺省为80
port=8983

#  当前solr应用上下文的名称
webapp=solr

#  请求增量更新的URL地址
params=/dataimport?command=delta-import&amp;clean=false&amp;commit=true

#  定时执行的时间间隔，单位为分钟，若为空则默认30
interval=3
</code></pre></div><p>至此定时增量更新已配置完成，重新启动solr，观察是否有错误，没有任何问题的话，查看日志，每个3分钟会定时增量更新。</p><h2 id="c">附录 C</h2><p>经常在使用dih数据库导入时经常会出现sql的错误，此时定位问题常常很消耗时间，有时我们需要直接到日志中查看执行的sql语句方便用于丁文问题，此时可以通过log4jdbc实现此功能，具体步骤如下：</p><ol><li>下载log4jdbc包放到$SOLR_HOME/server/solr-webapp/webapp/WEB-INF/lib目录中</li><li>在solrconfig.xml或者db-data-config.xml文件中进行配置</li></ol><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;requestHandler</span> <span class="na">name=</span><span class="s">"/dataimport"</span> <span class="na">class=</span><span class="s">"org.apache.solr.handler.dataimport.DataImportHandler"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">"defaults"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"config"</span><span class="nt">&gt;</span>db-data-config.xml<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">"datasource"</span><span class="nt">&gt;</span>
         <span class="c">&lt;!--
         &lt;str name="driver"&gt;com.mysql.jdbc.Driver&lt;/str&gt;
         &lt;str name="url"&gt;jdbc:mysql://127.0.0.1:3306/solr&lt;/str&gt;
         --&gt;</span>
         <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"driver"</span><span class="nt">&gt;</span>net.sf.log4jdbc.DriverSpy<span class="nt">&lt;/str&gt;</span>
         <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"url"</span><span class="nt">&gt;</span>jdbc:log4jdbc:mysql://127.0.0.1:3306/solr<span class="nt">&lt;/str&gt;</span>
         <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"user"</span><span class="nt">&gt;</span>root<span class="nt">&lt;/str&gt;</span>
         <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>root<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;/lst&gt;</span>
    <span class="nt">&lt;/lst&gt;</span>
<span class="nt">&lt;/requestHandler&gt;</span>
</code></pre></div><p>此时执行的sql日志输出如下</p><div class="highlighter-rouge"><pre class="highlight"><code>1441106 INFO  (qtp987405879-18) [   x:core] j.sqltiming select product_id from product where create_time &gt; '2016-07-12 03:21:29' 
 {executed in 1 msec}
</code></pre></div><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="http://www.vinny.cc//2016/08/solr-dih-import/" akt="">http://www.vinny.cc//2016/08/solr-dih-import/</a></div></blockquote><div class="divider"></div><!-- 多说评论框 start --><div class="ds-thread" data-thread-key="29bca95032aff645a6f67f03e45bddfb" data-title="solr-dih增量与全量导入配置详解" data-url="/2016/08/solr-dih-import/"></div><!-- 多说评论框 end --></article><div class="page-navigation"> <a class="next" href="/2016/08/solr-cursormark/" title="NEXT: solr-使用游标cursorMark高效率的翻页查询">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">首页</a> <span> &middot; </span> <a class="prev" href="/2016/08/solr-more-like-this/" title="PREV: solr-morelikethis相似度查询的使用说明">&gt;&gt;</a></div><!-- 多说公共JS代码 start (一个网页只需插入一次) --> <script type="text/javascript"> var duoshuoQuery = {short_name:"wangjunneil"}; (function() { var ds = document.createElement('script'); ds.type = 'text/javascript';ds.async = true; ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js'; ds.charset = 'UTF-8'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds); })(); </script> <!-- 多说公共JS代码 end --></main><div class="footer"> <!-- <span class="block">Made with &hearts; using <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="https://github.com/heiswayi/the-plain" title="The Plain theme by Heiswayi Nrird">The Plain</a> &middot; &lt;/&gt; on <a href="https://github.com/wangjunneil" title="Hosted on GitHub">GitHub</a></span> --> <span class="block"><a href="https://wangjunneil.github.io">Vinny's Blog</a> © 2016 - All Rights Reserved</span></div><script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?9c10955e76f3568532fff91d922d32ac"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> // google分析 </script></body></html>