<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="baidu-site-verification" content="gDf3P6sfyW" /><meta name="360-site-verification" content="0c91ee58977e5924d92896a89289b668" /><meta name="sogou_site_verification" content="jHNtHqKt34"/><meta name="google-site-verification" content="An2eGWQakKFcIZ1YuwZSilNuSYlfHs1zH0Hr-OMW6oQ" /><title>solr-morelikethis相似度查询的使用说明</title><meta name="description" content=""><meta name="keywords" content="solr,morelikethis,相似度查询"><link rel="icon" href="/assets/favicon.ico"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2016/08/solr-more-like-this/"><link rel="alternate" type="application/atom+xml" title="Vinny Wong's Blog" href="/feed.xml" /></head><body> <!-- search --><div class="searchform"> <label class="mk">$> </label> <input type="text" id="keyword"/> <a href="javascript:void(0);" class="clear"></a><ul class="suggest"></ul></div><script src="//lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script> <script src="/assets/main.js"></script><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> / <a class="page-link" href="/about/">ABOUT</a></nav><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>solr-morelikethis相似度查询的使用说明</h1><time>2016-08-01</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#solr-morelikethis相似度查询的使用说明" id="markdown-toc-solr-morelikethis相似度查询的使用说明">Solr-morelikethis相似度查询的使用说明</a><ul><li><a href="#1-简介" id="markdown-toc-1-简介">1. 简介</a></li><li><a href="#2-使用" id="markdown-toc-2-使用">2. 使用</a><ul><li><a href="#21-在需要使用相似度查询的字段上属性termvectors" id="markdown-toc-21-在需要使用相似度查询的字段上属性termvectors">2.1 在需要使用相似度查询的字段上属性termVectors</a></li><li><a href="#22-常用的morelikethis通用请求参数" id="markdown-toc-22-常用的morelikethis通用请求参数">2.2 常用的morelikethis通用请求参数</a></li><li><a href="#23-两种实现方式的使用" id="markdown-toc-23-两种实现方式的使用">2.3 两种实现方式的使用</a></li></ul></li><li><a href="#3-场景案例" id="markdown-toc-3-场景案例">3. 场景案例</a></li></ul></li></ul><hr /><h1 id="solr-morelikethis相似度查询的使用说明">Solr-morelikethis相似度查询的使用说明</h1><h2 id="1-简介">1. 简介</h2><p><strong>solr</strong>的<strong>morelikethis</strong>从字面的解释是”<strong>更多的类似这个</strong>“，常常用在关联查询上，使用上很简单，更多的是在solr查询语法上，<strong>morelikethis</strong>有两种实现方式，<strong>MoreLikeThisHandler</strong>和<strong>SearchHandler</strong>。</p><h2 id="2-使用">2. 使用</h2><h3 id="21-在需要使用相似度查询的字段上属性termvectors">2.1 在需要使用相似度查询的字段上属性termVectors</h3><p>在<strong>schema.xml</strong>中配置需要使用相似度查询的字段，在其增加”<strong>termVectors=true</strong>“的属性，这里在<strong>productName</strong>和<strong>productCode</strong>字段中增加，如下：</p><div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productId"</span> <span class="na">type=</span><span class="s">"int"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productName"</span> <span class="na">type=</span><span class="s">"text_ik"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="na">termVectors=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productPrice"</span> <span class="na">type=</span><span class="s">"float"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"productCode"</span> <span class="na">type=</span><span class="s">"string"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="na">termVectors=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"createTime"</span> <span class="na">type=</span><span class="s">"date"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">required=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
</code></pre></div><p>如何确定相似度字段，例如查询<strong>productId</strong>为<strong>10005</strong>的产品及其相似产品，那么就需要确定哪个属性做相似度，比如做了分词的商品名称、商品助记码或者商品关键字。<strong>这里注意的是若是没有分词的字段是全量匹配</strong>。</p><h3 id="22-常用的morelikethis通用请求参数">2.2 常用的morelikethis通用请求参数</h3><p>现在不必理解这些参数，需要结合下面几个案例去理解。这里通用参数指的是<strong>MoreLikeThisHandler</strong>和<strong>SearchHandler</strong>都可以使用的。</p><table><thead><tr><th>名称</th><th>含义</th></tr></thead><tbody><tr><td>mlt.fl</td><td>指定需要查询的相似度字段，多个用逗号分隔（需要使用termVectors=”true”声明的字段）</td></tr><tr><td>mlt.mintf</td><td>最小分词频率，在单个文档中小于这个值的词将不用于相似判断</td></tr><tr><td>mlt.mindf</td><td>最小文档频率，所在文档的个数小于这个词将不用于相似判断</td></tr><tr><td>mlt.minwl</td><td>最小单词长度，小于此长度的字段都不做相似度查询</td></tr><tr><td>mlt.maxwl</td><td>最大单词长度，大于此长度的字段都不做相似度查询</td></tr></tbody></table><h3 id="23-两种实现方式的使用">2.3 两种实现方式的使用</h3><p><strong>SearchHandler</strong>和<strong>MoreLikeThisHandler</strong>使用基本相同，<strong>SearchHandler</strong>使用的是原有的<strong>select</strong>方式检索数据，不需要配置什么，直接可以使用。而<strong>MoreLikeThisHandler</strong>则需要在<strong>solrconfig.xml</strong>中注册请求处理器，配置也很简单，将以下代码添加到<strong>solrconfig.xml</strong>中即可。</p><div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;requestHandler</span> <span class="na">name=</span><span class="s">"/mlt"</span> <span class="na">class=</span><span class="s">"solr.MoreLikeThisHandler"</span><span class="nt">&gt;&lt;/requestHandler&gt;</span>
</code></pre></div><p>下面是两种方式请求相同数据的路径：</p><div class="highlighter-rouge"><pre class="highlight"><code>http://localhost:8983/solr/core/select?q=productId%3A10003&amp;wt=json&amp;indent=true&amp;mlt=true&amp;mlt.fl=productName

http://localhost:8983/solr/core/mlt?q=productId%3A10003&amp;wt=json&amp;indent=true&amp;mlt=true&amp;mlt.fl=productName
</code></pre></div><p>由上面可知，两种实现方式目前仅仅是请求的路径不一样，一个是”<strong>/select</strong>“，另外一个是”<strong>/mlt</strong>“的，返回的结果集是相同的，具体使用哪种方式还请自行实践。</p><h2 id="3-场景案例">3. 场景案例</h2><div class="highlighter-rouge"><pre class="highlight"><code># 根据productId查询单个商品并以productName为相似度字段检索出相关商品
http://localhost:8983/solr/core/mlt?q=productId%3A10003&amp;wt=json&amp;indent=true&amp;mlt=true&amp;mlt.fl=productName

# 根据productId查询单个商品并以productName和productCode为相似度字段检索出相关商品
http://localhost:8983/solr/core/mlt?q=productId%3A10003&amp;wt=json&amp;indent=true&amp;mlt=true&amp;mlt.fl=productName,productCode

# 根据productId查询单个商品并以productName为相似度字段检索出相关商品，条目数限定为5条
http://localhost:8983/solr/core/mlt?q=productId%3A10003&amp;wt=json&amp;indent=true&amp;mlt=true&amp;mlt.fl=productName&amp;mlt.count=3
</code></pre></div><p>相似度检索数据，需要先定义需要做声明相似度的字段，这个字段可以是任何类型也可以是中文分词，根据不同参数控制检索的数据粒度，结合自己的业务筛选出合适的关联数据。</p><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="http://www.vinny.cc//2016/08/solr-more-like-this/" akt="">http://www.vinny.cc//2016/08/solr-more-like-this/</a></div></blockquote><div class="divider"></div><a class="w-search active" href="#" title="forward to search">⊙</a> <a class="w-catalog active" href="javascript:void(0);" title="open to catalog">≣</a></article><div class="page-navigation"> <a class="next" href="/2016/08/solr-dih-import/" title="NEXT: solr-dih增量与全量导入配置详解">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">Home</a> <span> &middot; </span> <a class="prev" href="/2016/08/no-ide-code-dotnet/" title="PREV: 不使用visualstudio开发.netframework的windows应用">&gt;&gt;</a></div></main><div class="footer"> <!-- <span class="block">Made with &hearts; using <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="https://github.com/heiswayi/the-plain" title="The Plain theme by Heiswayi Nrird">The Plain</a> &middot; &lt;/&gt; on <a href="https://github.com/wangjunneil" title="Hosted on GitHub">GitHub</a></span> --> <span class="block"><a href="https://vinny.cc">Vinny's Blog</a> © 2017 - All Rights Reserved</span></div><!-- include baidu_tongji.html include baidu_push.html include 360_push.html include google_analytics.html --></body></html>