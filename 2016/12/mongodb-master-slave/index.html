<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="baidu-site-verification" content="20aAL2tUWx" /><meta name="google-site-verification" content="An2eGWQakKFcIZ1YuwZSilNuSYlfHs1zH0Hr-OMW6oQ" /><title>高可用的mongodb:master-slave配置</title><meta name="description" content=""><meta name="keywords" content="mongodb,mongodb集群,mongodb-master-slave"><link rel="icon" href="/assets/favicon.ico"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2016/12/mongodb-master-slave/"><link rel="alternate" type="application/atom+xml" title="Vinny's Blog - 王俊博客 - 交流软件领域知识 | 纪录点滴精彩人生" href="/feed.xml" /></head><body><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> / <a class="page-link" href="/about/">ABOUT</a></nav><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>高可用的mongodb:master-slave配置</h1><time>2016-12-03</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#master-slave" id="markdown-toc-master-slave">1. master-slave模式</a></li><li><a href="#mongodbmaster-slave" id="markdown-toc-mongodbmaster-slave">2. MongoDB的主从master-slave模式</a><ul><li><a href="#section" id="markdown-toc-section">2.1 环境准备</a></li><li><a href="#section-1" id="markdown-toc-section-1">2.2 下载安装包并分别创建数据目录</a></li><li><a href="#mongodb" id="markdown-toc-mongodb">2.3 分别启动主从节点的mongodb</a></li></ul></li><li><a href="#section-2" id="markdown-toc-section-2">3 验证主从配置</a><ul><li><a href="#section-3" id="markdown-toc-section-3">3.1 数据同步测试</a></li><li><a href="#section-4" id="markdown-toc-section-4">3.2 故障转移测试</a></li></ul></li><li><a href="#mongodb-1" id="markdown-toc-mongodb-1">4. MongoDB主从模式结论</a></li></ul><h2 id="master-slave">1. master-slave模式</h2><p>主从模式可以避免单机故障，双机备份后，若主节点挂掉，从节点可以接替主节点继续服务。主节点数据的录入会实时同步到从节点上。</p><h2 id="mongodbmaster-slave">2. MongoDB的主从master-slave模式</h2><h3 id="section">2.1 环境准备</h3><p>两台服务器，一台用作主节点，一台用作从节点，如下：</p><ul><li>192.168.1.101 (主节点)</li><li>192.168.1.102 (从节点)</li></ul><h3 id="section-1">2.2 下载安装包并分别创建数据目录</h3><p>从 MongoDB官网下载安装包，地址：<a href="http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.4.9.tgz">http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.4.9.tgz</a></p><p>分别上传到主从服务器中并解压，分别创建各自的数据目录，如下：</p><p>主节点数据目录：<strong>/root/mongodb-linux-x86_64-2.4.9/data/master</strong><br /> 从节点数据目录：<strong>/root/mongodb-linux-x86_64-2.4.9/data/slave</strong></p><blockquote><p>数据目录可以随意创建，这里只是为了区分主从，也可以直接各自指定 <strong>{MONGODB_HOME}/data</strong>目录即可。</p></blockquote><h3 id="mongodb">2.3 分别启动主从节点的mongodb</h3><p><strong>启动主节点上（192.168.1.101）的 MongoDB</strong></p><div class="highlighter-rouge"><pre class="highlight"><code>./mongod --dbpath /root/mongodb-linux-x86_64-2.4.9/data/master --master
</code></pre></div><p><strong>启动从节点上（192.168.1.102）的 MongoDB</strong></p><div class="highlighter-rouge"><pre class="highlight"><code>./mongod --dbpath /root/mongodb-linux-x86_64-2.4.9/data/slave --slave --source 192.168.1.101:27017
</code></pre></div><p><strong>–master</strong> 表明此节点是作为主节点使用，<strong>–slave</strong> 和 <strong>–source</strong> 表示节点是从节点且主节点的源地址是哪里。</p><blockquote><p>主从的启动仔细观察日志可以看出是否启动成功，在从节点上可以使用命令<code class="highlighter-rouge">db.printReplicationInfo()</code>进行查看。</p></blockquote><h2 id="section-2">3 验证主从配置</h2><h3 id="section-3">3.1 数据同步测试</h3><p>进入主节点的<code class="highlighter-rouge">mongodb</code>环境，创建一条数据</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">&gt; </span>./mongo 192.168.1.101:27017
<span class="gp">&gt; </span>use demo;
<span class="gp">&gt; </span>db.post.insert<span class="o">({</span><span class="s2">"title"</span>:<span class="s2">"AAAAAA"</span><span class="o">})</span>;
<span class="gp">&gt; </span>db.post.find<span class="o">()</span>;
<span class="o">{</span> <span class="s2">"_id"</span> : ObjectId<span class="o">(</span><span class="s2">"5284e5cb1f4eb215b2ecc463"</span><span class="o">)</span>, <span class="s2">"title"</span> : <span class="s2">"AAAAAA"</span> <span class="o">}</span>
</code></pre></div><blockquote><p>此时查看日志，发现新添加的数据已经同步到子节点上。</p></blockquote><p>进入子节点的<code class="highlighter-rouge">mongodb</code>环境，查看主节点上创建的数据</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">&gt; </span>./mongo 192.168.1.102:27017
<span class="gp">&gt; </span>use demo;
<span class="gp">&gt; </span>db.post.find<span class="o">()</span>;
<span class="o">{</span> <span class="s2">"_id"</span> : ObjectId<span class="o">(</span><span class="s2">"5284e5cb1f4eb215b2ecc463"</span><span class="o">)</span>, <span class="s2">"title"</span> : <span class="s2">"AAAAAA"</span> <span class="o">}</span>
</code></pre></div><p>从子节点上可以看出，主节点上创建的任何数据都会实时同步到子节点上，这样主从模式基本就形成了。</p><h3 id="section-4">3.2 故障转移测试</h3><p>从节点上不允许插入数据，只允许读，插入数据时会提示 <strong>no master</strong> 错误。</p><p>关闭主节点后，从节点会不断尝试连接主节点，还是只读模式，并不能自动切换成主节点，</p><h2 id="mongodb-1">4. MongoDB主从模式结论</h2><p><strong>MongoDB</strong> 的主从配置很简单，主从模式只有数据同步没有<strong>master</strong>节点自动转移功能，当主节点不可用时，需要手动将从节点升级成master。</p><blockquote><p>从节点手动升级为主节点：./mongod –dbpath /root/mongodb-linux-x86_64-2.4.9/data/slave –master</p></blockquote><p>./mongod –dbpath /Volumes/TOD/mongodb-osx-x86_64-2.0.6/data/replset0 –replSet replse</p><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="http://www.vinny.cc//2016/12/mongodb-master-slave/" akt="">http://www.vinny.cc//2016/12/mongodb-master-slave/</a></div></blockquote><div class="divider"></div><!-- 多说评论框 start --><div class="ds-thread" data-thread-key="29bca95032aff645a6f67f03e45bddfb" data-title="高可用的mongodb:master-slave配置" data-url="/2016/12/mongodb-master-slave/"></div><!-- 多说评论框 end --></article><div class="page-navigation"> <a class="next" href="/2016/12/mongodb-replica/" title="NEXT: 高可用的mongodb:副本集replica set配置">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">首页</a> <span> &middot; </span> <a class="prev" href="/2016/11/use-smbclient-in-kali/" title="PREV: Kali系统中使用smbclient访问windows共享目录">&gt;&gt;</a></div><!-- 多说公共JS代码 start (一个网页只需插入一次) --> <script type="text/javascript"> var duoshuoQuery = {short_name:"wangjunneil"}; (function() { var ds = document.createElement('script'); ds.type = 'text/javascript';ds.async = true; ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js'; ds.charset = 'UTF-8'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds); })(); </script> <!-- 多说公共JS代码 end --></main><div class="footer"> <!-- <span class="block">Made with &hearts; using <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="https://github.com/heiswayi/the-plain" title="The Plain theme by Heiswayi Nrird">The Plain</a> &middot; &lt;/&gt; on <a href="https://github.com/wangjunneil" title="Hosted on GitHub">GitHub</a></span> --> <span class="block"><a href="https://wangjunneil.github.io">Vinny's Blog</a> © 2016 - All Rights Reserved</span></div></body></html>