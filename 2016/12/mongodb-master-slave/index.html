<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- pwa meta begin --><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#000"><meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="msapplication-tap-highlight" content="no"> <!-- IOS不会读取manifest中的icon，用此配置进行适配 --><link rel="apple-touch-icon" href="assets/icons/icon-96x96.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/icons/icon-167x167.png"> <!-- ios修复splash黑屏 --><link href="/assets/icons/apple_splash_1125.png" sizes="1125x2436" rel="apple-touch-startup-image" /><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"> <!-- pwa meta end --><title>高可用的mongodb:master-slave配置</title><meta name="description" content=""><meta name="keywords" content="mongodb,mongodb集群,mongodb-master-slave"><link rel="icon" href="/assets/favicon.ico"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2016/12/mongodb-master-slave/"><link rel="alternate" type="application/atom+xml" title="Vinny Wong's Blog" href="/feed.xml" /></head><body> <!-- 全局页面loading --><div class="loading"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div><!-- search --><div class="searchform"> <a href="javascript:void(0);" class="searchicon"></a> <input type="text" id="keyword"/> <a href="javascript:void(0);" class="clear"></a><ul class="suggest"></ul></div><script src="/assets/jquery-1.9.1.min.js"></script> <script src="/assets/main.js"></script><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> / <a class="page-link" href="/about/">ABOUT</a></nav><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article> <!-- 目录导航，在nav,js中进行渲染 --><div class="w-catalog"></div><div class="w-catalog-btn">目录</div><div class="center"><h1>高可用的mongodb:master-slave配置</h1><time>2016-12-03</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#1-master-slave模式" id="markdown-toc-1-master-slave模式">1. master-slave模式</a></li><li><a href="#2-mongodb的主从master-slave模式" id="markdown-toc-2-mongodb的主从master-slave模式">2. MongoDB的主从master-slave模式</a><ul><li><a href="#21-环境准备" id="markdown-toc-21-环境准备">2.1 环境准备</a></li><li><a href="#22-下载安装包并分别创建数据目录" id="markdown-toc-22-下载安装包并分别创建数据目录">2.2 下载安装包并分别创建数据目录</a></li><li><a href="#23-分别启动主从节点的mongodb" id="markdown-toc-23-分别启动主从节点的mongodb">2.3 分别启动主从节点的mongodb</a></li></ul></li><li><a href="#3-验证主从配置" id="markdown-toc-3-验证主从配置">3 验证主从配置</a><ul><li><a href="#31-数据同步测试" id="markdown-toc-31-数据同步测试">3.1 数据同步测试</a></li><li><a href="#32-故障转移测试" id="markdown-toc-32-故障转移测试">3.2 故障转移测试</a></li></ul></li><li><a href="#4-mongodb主从模式结论" id="markdown-toc-4-mongodb主从模式结论">4. MongoDB主从模式结论</a></li></ul><h2 id="1-master-slave模式">1. master-slave模式</h2><p>主从模式可以避免单机故障，双机备份后，若主节点挂掉，从节点可以接替主节点继续服务。主节点数据的录入会实时同步到从节点上。</p><h2 id="2-mongodb的主从master-slave模式">2. MongoDB的主从master-slave模式</h2><h3 id="21-环境准备">2.1 环境准备</h3><p>两台服务器，一台用作主节点，一台用作从节点，如下：</p><ul><li>192.168.1.101 (主节点)</li><li>192.168.1.102 (从节点)</li></ul><h3 id="22-下载安装包并分别创建数据目录">2.2 下载安装包并分别创建数据目录</h3><p>从 MongoDB官网下载安装包，地址：<a href="//fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.4.9.tgz">//fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.4.9.tgz</a></p><p>分别上传到主从服务器中并解压，分别创建各自的数据目录，如下：</p><p>主节点数据目录：<strong>/root/mongodb-linux-x86_64-2.4.9/data/master</strong> 从节点数据目录：<strong>/root/mongodb-linux-x86_64-2.4.9/data/slave</strong></p><blockquote><p>数据目录可以随意创建，这里只是为了区分主从，也可以直接各自指定 <strong>{MONGODB_HOME}/data</strong>目录即可。</p></blockquote><h3 id="23-分别启动主从节点的mongodb">2.3 分别启动主从节点的mongodb</h3><p><strong>启动主节点上（192.168.1.101）的 MongoDB</strong></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./mongod <span class="nt">--dbpath</span> /root/mongodb-linux-x86_64-2.4.9/data/master <span class="nt">--master</span>
</code></pre></div></div><p><strong>启动从节点上（192.168.1.102）的 MongoDB</strong></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./mongod <span class="nt">--dbpath</span> /root/mongodb-linux-x86_64-2.4.9/data/slave <span class="nt">--slave</span> <span class="nt">--source</span> 192.168.1.101:27017
</code></pre></div></div><p><strong>–master</strong> 表明此节点是作为主节点使用，<strong>–slave</strong> 和 <strong>–source</strong> 表示节点是从节点且主节点的源地址是哪里。</p><blockquote><p>主从的启动仔细观察日志可以看出是否启动成功，在从节点上可以使用命令<code class="highlighter-rouge">db.printReplicationInfo()</code>进行查看。</p></blockquote><h2 id="3-验证主从配置">3 验证主从配置</h2><h3 id="31-数据同步测试">3.1 数据同步测试</h3><p>进入主节点的<code class="highlighter-rouge">mongodb</code>环境，创建一条数据</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> ./mongo 192.168.1.101:27017
<span class="o">&gt;</span> use demo<span class="p">;</span>
<span class="o">&gt;</span> db.post.insert<span class="o">({</span><span class="s2">"title"</span>:<span class="s2">"AAAAAA"</span><span class="o">})</span><span class="p">;</span>
<span class="o">&gt;</span> db.post.find<span class="o">()</span><span class="p">;</span>
<span class="o">{</span> <span class="s2">"_id"</span> : ObjectId<span class="o">(</span><span class="s2">"5284e5cb1f4eb215b2ecc463"</span><span class="o">)</span>, <span class="s2">"title"</span> : <span class="s2">"AAAAAA"</span> <span class="o">}</span>
</code></pre></div></div><blockquote><p>此时查看日志，发现新添加的数据已经同步到子节点上。</p></blockquote><p>进入子节点的<code class="highlighter-rouge">mongodb</code>环境，查看主节点上创建的数据</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> ./mongo 192.168.1.102:27017
<span class="o">&gt;</span> use demo<span class="p">;</span>
<span class="o">&gt;</span> db.post.find<span class="o">()</span><span class="p">;</span>
<span class="o">{</span> <span class="s2">"_id"</span> : ObjectId<span class="o">(</span><span class="s2">"5284e5cb1f4eb215b2ecc463"</span><span class="o">)</span>, <span class="s2">"title"</span> : <span class="s2">"AAAAAA"</span> <span class="o">}</span>
</code></pre></div></div><p>从子节点上可以看出，主节点上创建的任何数据都会实时同步到子节点上，这样主从模式基本就形成了。</p><h3 id="32-故障转移测试">3.2 故障转移测试</h3><p>从节点上不允许插入数据，只允许读，插入数据时会提示 <strong>no master</strong> 错误。</p><p>关闭主节点后，从节点会不断尝试连接主节点，还是只读模式，并不能自动切换成主节点，</p><h2 id="4-mongodb主从模式结论">4. MongoDB主从模式结论</h2><p><strong>MongoDB</strong> 的主从配置很简单，主从模式只有数据同步没有<strong>master</strong>节点自动转移功能，当主节点不可用时，需要手动将从节点升级成master。</p><blockquote><p>从节点手动升级为主节点：./mongod –dbpath /root/mongodb-linux-x86_64-2.4.9/data/slave –master</p></blockquote><p>./mongod –dbpath /Volumes/TOD/mongodb-osx-x86_64-2.0.6/data/replset0 –replSet replse</p><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="http://localhost:4000//2016/12/mongodb-master-slave/" akt="">http://localhost:4000//2016/12/mongodb-master-slave/</a></div></blockquote><div class="divider"></div></article><div class="page-navigation"> <a class="next" href="/2016/12/mongodb-replica/" title="NEXT: 高可用的mongodb:副本集replica set配置">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">Home</a> <span> &middot; </span> <a class="prev" href="/2016/11/use-smbclient-in-kali/" title="PREV: Kali系统中使用smbclient访问windows共享目录">&gt;&gt;</a></div><!-- 书签处理 --> <script type="text/javascript" src="/assets/js/zepto.min.js"></script> <script type="text/javascript" src="/assets/js/nav.js"></script></main><!--<div class="footer"> --> <!--</div>--></body></html>