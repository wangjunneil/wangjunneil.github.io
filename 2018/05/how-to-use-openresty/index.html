<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- pwa meta begin --><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#000"><meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="msapplication-tap-highlight" content="no"> <!-- IOS不会读取manifest中的icon，用此配置进行适配 --><link rel="apple-touch-icon" href="assets/icons/icon-96x96.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/icons/icon-167x167.png"> <!-- ios修复splash黑屏 --><link href="/assets/icons/apple_splash_1125.png" sizes="1125x2436" rel="apple-touch-startup-image" /><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"> <!-- pwa meta end --><title>Openresty 的安装使用及案例介绍</title><meta name="description" content=""><meta name="keywords" content="nginx,openrety,redis,lua"><link rel="icon" href="/assets/favicon.ico"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2018/05/how-to-use-openresty/"><link rel="alternate" type="application/atom+xml" title="Vinny Wong's Blog" href="/feed.xml" /></head><body> <!-- 全局页面loading --><div class="loading"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div><!-- search --><div class="searchform"> <a href="javascript:void(0);" class="searchicon"></a> <input type="text" id="keyword"/> <a href="javascript:void(0);" class="clear"></a><ul class="suggest"></ul></div><script src="/assets/jquery-1.9.1.min.js"></script> <!-- 图片懒加载 --> <!-- <script src="//cdn.jsdelivr.net/npm/lozad"></script> --> <script src="/assets/main.js"></script><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> / <a class="page-link" href="/about/">ABOUT</a></nav><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article> <!-- 目录导航，在nav,js中进行渲染 --><div class="w-catalog"></div><div class="w-catalog-btn">目录</div><div class="center"><h1>Openresty 的安装使用及案例介绍</h1><time>2018-05-24</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#环境准备" id="markdown-toc-环境准备">环境准备</a><ul><li><a href="#安装openresty" id="markdown-toc-安装openresty">安装openresty</a></li><li><a href="#安装redis" id="markdown-toc-安装redis">安装redis</a></li></ul></li><li><a href="#结合lua脚本" id="markdown-toc-结合lua脚本">结合lua脚本</a><ul><li><a href="#hello-world" id="markdown-toc-hello-world">Hello World</a></li><li><a href="#变量的使用" id="markdown-toc-变量的使用">变量的使用</a></li><li><a href="#访问redis" id="markdown-toc-访问redis">访问redis</a></li></ul></li><li><a href="#综合案例" id="markdown-toc-综合案例">综合案例</a><ul><li><a href="#动态反向代理" id="markdown-toc-动态反向代理">动态反向代理</a></li><li><a href="#动态ip白名单" id="markdown-toc-动态ip白名单">动态IP白名单</a></li></ul></li><li><a href="#附录a-使用第三方lua库" id="markdown-toc-附录a-使用第三方lua库">附录A 使用第三方lua库</a></li><li><a href="#附录b-如何封装调用" id="markdown-toc-附录b-如何封装调用">附录B 如何封装调用</a></li></ul><h2 id="环境准备">环境准备</h2><h3 id="安装openresty">安装openresty</h3><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装依赖</span>
<span class="nv">$ </span>yum <span class="nb">install</span> <span class="nt">-y</span> perl readline-devel pcre-devel openssl-devel gcc
<span class="c"># 下载安装包</span>
<span class="nv">$ </span>wget https://openresty.org/download/openresty-1.11.2.5.tar.gz

<span class="c"># 执行安装</span>
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-zxvf</span> openresty-1.11.2.5.tar.gz
<span class="nv">$ </span><span class="nb">cd </span>openresty-1.11.2.5
<span class="nv">$ </span>./configure
<span class="nv">$ </span>gmake &amp; gmake <span class="nb">install</span>
</code></pre></div></div><p>安装完成后，默认的安装目录是 <em>/usr/local/openresty</em>，进入 <em>/usr/local/openresty/nginx/sbin</em> 目录，使用命令 <code class="highlighter-rouge">./nginx</code> 启动nginx，打开网页查看安装是否成功。</p><p><img src="http://ohdpyqlwy.bkt.clouddn.com/openresty.png" /></p><h3 id="安装redis">安装redis</h3><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载并安装</span>
<span class="nv">$ </span>wget http://download.redis.io/releases/redis-3.2.1.tar.gz
<span class="nv">$ </span><span class="nb">tar </span>xzf redis-3.2.1.tar.gz
<span class="nv">$ </span><span class="nb">cd </span>redis-3.2.1
<span class="nv">$ </span>make <span class="o">&amp;&amp;</span> make <span class="nb">install</span>

<span class="c"># 创建运行目录</span>
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /usr/local/redis/bin
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /usr/local/redis/etc
<span class="nv">$ </span><span class="nb">mv </span>redis.conf /usr/local/redis/etc
<span class="nv">$ </span><span class="nb">cd </span>src
<span class="nv">$ </span><span class="nb">mv </span>mkreleasehdr.sh redis-benchmark redis-check-aof redis-cli redis-server /usr/local/redis/bin/

<span class="c"># 启用与关闭</span>
<span class="nv">$ </span><span class="nb">cd</span> /usr/local/redis/bin/
<span class="c"># 启动，redis.conf里daemonize设置为yes可以后台启动</span>
<span class="nv">$ </span>./redis-server /usr/local/redis/etc/redis.conf
<span class="c"># 关闭，也可使用"pkill redis-server"命令</span>
<span class="nv">$ </span>./redis-cli shutdown
</code></pre></div></div><p>如希望开机自动启动 redis，则编辑 <code class="highlighter-rouge">vi /etc/rc.local</code> 文件，增加如下条目</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf
</code></pre></div></div><h2 id="结合lua脚本">结合lua脚本</h2><h3 id="hello-world">Hello World</h3><p>在 <em>/usr/local/openresty/nginx/conf/nginx.conf</em> 中添加如下内容：</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    ...
    
    location /lua {
	    default_type 'text/html';
	    lua_code_cache off;
	    
	    content_by_lua '
			ngx.say("Hello World");
	    ';
	}
    
    ...
}
</code></pre></div></div><p>重启 <strong>nginx</strong> 并使用浏览器访问 <em>/lua</em> 正常输出 “Hello World”。</p><p>由上面可知，可以直接在 nginx 配置文件中可以使用 <strong>content_by_lua</strong> 访问 lua 脚本语言，当然也可以使用 <strong>content_by_lua_file</strong> 指定 lua 脚本文件进行执行。</p><p>另外 <strong>lua_code_cache</strong> 可以控制动态加载 lua 脚本。</p><h3 id="变量的使用">变量的使用</h3><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
    default_type text/html;
    content_by_lua 'ngx.print(ngx.var.remote_addr)';
}
</code></pre></div></div><h3 id="访问redis">访问redis</h3><p>在 nginx 配置文件中配置 lua 脚本路径，如：</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
    default_type text/html;
    content_by_lua_file /usr/local/openresty/nginx/conf/redisopr.lua;
}
</code></pre></div></div><p>[ <strong>redisopr.lua</strong> ]</p><div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">redis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">'resty.redis'</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">cache</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="s1">'6379'</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">ngx</span><span class="p">.</span><span class="n">null</span> <span class="k">then</span>
    <span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="s1">'This is Null'</span><span class="p">);</span>
<span class="k">end</span>

<span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div></div><h2 id="综合案例">综合案例</h2><h3 id="动态反向代理">动态反向代理</h3><p>原来在nginx中配置反向代理都是直接在配置文件中硬编码，以 lua 语言为基础，redis 为媒介，动态读取配置的地址进行转向。</p><p>[ <strong>nginx.conf</strong> ]</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
    set $target '';
    access_by_lua_file /usr/local/openresty/nginx/conf/forword.lua;
    proxy_pass http://$target;
}
</code></pre></div></div><p>在配置中定义了 <strong>target</strong> 的变量，此变量会传递到 lua 脚本中进行赋值处理，在 proxy_pass 中进行读取以获取 target 的动态值。</p><p>[ <strong>forward.lua</strong> ]</p><div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">redis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">'resty.redis'</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">cache</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="s1">'6379'</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">"myname"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">ngx</span><span class="p">.</span><span class="n">null</span> <span class="k">then</span>
    <span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="s1">'This is Null'</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">end</span>

<span class="c1">-- target变量赋值</span>
<span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">res</span>
</code></pre></div></div><h3 id="动态ip白名单">动态IP白名单</h3><p>[ <strong>nginx.conf</strong> ]</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
    lua_shared_dict ip_blacklist 1m;
    server {
        listen 80;
        server_name localhost;
        
        location = /ipblacklist {
            access_by_lua_file lua/ip_blacklist.lua;
            default_type text/html;
            content_by_lua '
            	ngx.say("&lt;p&gt;hello, lua&lt;/p&gt;");
            ';
        }
    }
}
</code></pre></div></div><p>这里使用 <strong>lua_shared_dict</strong> 使 nginx 进程分配一块 1M 大小的空间，用来缓存 IP 黑名单，让其不需要每次都从redis中读取，具体参见：<a href="https://github.com/openresty/lua-nginx-module#lua_shared_dict">https://github.com/openresty/lua-nginx-module#lua_shared_dict</a>。</p><p>[ <strong>ip_blacklist.lua</strong> ]</p><div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">redis_host</span>    <span class="o">=</span> <span class="s2">"your.redis.server.here"</span>
<span class="kd">local</span> <span class="n">redis_port</span>    <span class="o">=</span> <span class="mi">6379</span>

<span class="c1">-- connection timeout for redis in ms. don't set this too high!</span>
<span class="kd">local</span> <span class="n">redis_connection_timeout</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1">-- check a set with this key for blacklist entries</span>
<span class="kd">local</span> <span class="n">redis_key</span>     <span class="o">=</span> <span class="s2">"ip_blacklist"</span>

<span class="c1">-- cache lookups for this many seconds</span>
<span class="kd">local</span> <span class="n">cache_ttl</span>     <span class="o">=</span> <span class="mi">60</span>

<span class="c1">-- end configuration</span>

<span class="kd">local</span> <span class="n">ip</span>                <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">remote_addr</span>
<span class="kd">local</span> <span class="n">ip_blacklist</span> 		<span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">ip_blacklist</span>
<span class="kd">local</span> <span class="n">last_update_time</span> 	<span class="o">=</span> <span class="n">ip_blacklist</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">"last_update_time"</span><span class="p">);</span>

<span class="c1">-- only update ip_blacklist from Redis once every cache_ttl seconds:</span>
<span class="k">if</span> <span class="n">last_update_time</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">or</span> <span class="n">last_update_time</span> <span class="o">&lt;</span> <span class="p">(</span> <span class="n">ngx</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">cache_ttl</span> <span class="p">)</span> <span class="k">then</span>

  <span class="kd">local</span> <span class="n">redis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"resty.redis"</span><span class="p">;</span>
  <span class="kd">local</span> <span class="n">red</span> <span class="o">=</span> <span class="n">redis</span><span class="p">:</span><span class="n">new</span><span class="p">();</span>

  <span class="n">red</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="n">redis_connect_timeout</span><span class="p">);</span>

  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">red</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">redis_host</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">);</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="k">then</span>
    <span class="n">ngx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">"Redis connection error while retrieving ip_blacklist: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="kd">local</span> <span class="n">new_ip_blacklist</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">red</span><span class="p">:</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_key</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
      <span class="n">ngx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">"Redis read error while retrieving ip_blacklist: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="c1">-- replace the locally stored ip_blacklist with the updated values:</span>
      <span class="n">ip_blacklist</span><span class="p">:</span><span class="n">flush_all</span><span class="p">();</span>
      <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">banned_ip</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">new_ip_blacklist</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">ip_blacklist</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">banned_ip</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">end</span>

      <span class="c1">-- update time</span>
      <span class="n">ip_blacklist</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s2">"last_update_time"</span><span class="p">,</span> <span class="n">ngx</span><span class="p">.</span><span class="n">now</span><span class="p">());</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">if</span> <span class="n">ip_blacklist</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">then</span>
  <span class="n">ngx</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">"Banned IP detected and refused access: "</span> <span class="o">..</span> <span class="n">ip</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ngx</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">HTTP_FORBIDDEN</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></div></div><p>在 redis 服务器中新建 Set 类型的数据 ip_blacklist，并加入 IP 黑名单。重新加载 nginx，配置就开始生效。</p><h2 id="附录a-使用第三方lua库">附录A 使用第三方lua库</h2><p>将下载的 lua 库文件放到 <em>/usr/local/openresty/lualib/</em> 路径中即可在脚本中正常调用，如：<a href="http://dkolf.de/src/dkjson-lua.fsl/home">dkjson</a></p><h2 id="附录b-如何封装调用">附录B 如何封装调用</h2><p>往往写的 lua 脚本不止一个文件，可能多个文件共同组合了 lua 程序，在 openresty 中将写好的 lua 服务脚本放到 <em>/usr/local/openresty/lualib/</em> 目录中，然后使用如下：</p><div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">redis_op</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"lua.redis_op"</span>

<span class="kd">local</span> <span class="n">upstream_addr</span> <span class="o">=</span> <span class="n">redis_op</span><span class="p">.</span><span class="n">get_upstream_from_redis</span><span class="p">()</span>
</code></pre></div></div><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="http://www.vinny.cc//2018/05/how-to-use-openresty/" akt="">http://www.vinny.cc//2018/05/how-to-use-openresty/</a></div></blockquote><div class="divider"></div></article><div class="page-navigation"> <a class="next" href="/2018/06/mysql-basic/" title="NEXT: centos7 中 mysql 的安装与配置">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">Home</a> <span> &middot; </span> <a class="prev" href="/2018/05/firebase-https/" title="PREV: 墙外使用 Firebase 搭建免费的 HTTPS 服务器">&gt;&gt;</a></div><!-- 书签处理 --> <script type="text/javascript" src="/assets/js/zepto.min.js"></script> <script type="text/javascript" src="/assets/js/nav.js"></script></main><!--<div class="footer"> --> <!--</div>--></body></html>