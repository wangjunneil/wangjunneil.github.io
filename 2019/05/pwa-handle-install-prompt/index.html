<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- pwa meta begin --><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#000"><meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="format-detection" content="telephone=no"><meta name="msapplication-tap-highlight" content="no"> <!-- IOS不会读取manifest中的icon，用此配置进行适配 --><link rel="apple-touch-icon" href="assets/icons/icon-96x96.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/icons/icon-167x167.png"> <!-- ios修复splash黑屏 --><link href="/assets/img/icons/apple_splash_1125.png" sizes="1125x2436" rel="apple-touch-startup-image" /><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"> <!-- pwa meta end --><title>PWA 之拦截 A2HS 实现自主应用添加主屏事件</title><meta name="description" content=""><meta name="keywords" content="pwa,install,prompt"><link rel="icon" href="/assets/favicon.ico"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2019/05/pwa-handle-install-prompt/"><link rel="alternate" type="application/atom+xml" title="The Jun Wong's blog" href="/feed.xml" /></head><body> <!-- 全局页面loading --><div class="loading"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div><!-- search --><div class="searchform"> <a href="javascript:void(0);" class="searchicon"></a> <input type="text" id="keyword"/> <a href="javascript:void(0);" class="clear"></a><ul class="suggest"></ul></div><script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> <script src="/assets/js/main.js"></script><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> <!-- <a class="page-link" href="/lab/index.html">MYLAB</a> --> / <a class="page-link" href="/about/">ABOUT</a></nav><main><article> <!-- 目录导航，在nav,js中进行渲染 --><div class="w-catalog"></div><div class="w-catalog-btn">目录</div><div class="center"><h1>PWA 之拦截 A2HS 实现自主应用添加主屏事件</h1><time>2019-05-29</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#1-概念" id="markdown-toc-1-概念">1. 概念</a></li><li><a href="#2-背景" id="markdown-toc-2-背景">2. 背景</a></li><li><a href="#3-beforeinstallprompt" id="markdown-toc-3-beforeinstallprompt">3. beforeinstallprompt</a></li><li><a href="#4-demo效果" id="markdown-toc-4-demo效果">4. demo效果</a></li><li><a href="#5-判断是否安装" id="markdown-toc-5-判断是否安装">5. 判断是否安装</a></li><li><a href="#6-参考链接" id="markdown-toc-6-参考链接">6. 参考链接</a></li></ul><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190530/1_hWVmsnBY6Fr6OoNvIU5pmg.png" alt="pwa-a2hs" /></p><h2 id="1-概念">1. 概念</h2><p><strong>A2HS</strong> 是（Add to Home screen）的缩写，也是PWA特性之一，它主要为web应用程序提供与本机应用程序相同的用户体验优势，将PWA应用添加至桌面后，用户可以像打开普通应用程序一样使用。</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190529/a2hs-1.png" alt="a2hs-1" /></p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190529/a2hs-2.png" alt="a2hs-2" /></p><h2 id="2-背景">2. 背景</h2><p>默认情况下，当编写的web应用满足pwa应用最低要求（manifest.json和service-sworker）时，浏览器会在提示用户可以将当前访问的web安装到桌面上，这个行为是浏览器控制的，用户是否可以不依赖于浏览器，不必每次都弹出 A2HS 的banner，行为由用户控制，如点击按钮提示安装，本文基于此目的编写。</p><h2 id="3-beforeinstallprompt">3. beforeinstallprompt</h2><p>要实现上述要求，需要监听 <em>beforeinstallprompt</em> 事件并进行处理。</p><p>实现代码如下：</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义A2HS事件对象</span>
<span class="kd">let</span> <span class="nx">installPromptEvent</span><span class="p">;</span>

<span class="c1">// 监听beforeinstallprompt事件，浏览器触发A2HS时会执行</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'beforeinstallprompt'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 阻止自动提示</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="c1">// 储存事件对象，方便在之后的按钮事件中手动触发</span>
  <span class="nx">installPromptEvent</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
<span class="p">});</span>
 
<span class="c1">// UI上的按钮点击事件</span>
<span class="nx">installBtn</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="c1">// 弹出A2HS提示</span>
  <span class="nx">installPromptEvent</span><span class="p">.</span><span class="nx">prompt</span><span class="p">();</span>
  <span class="c1">// 等待用户操作结果</span>
  <span class="nx">installPromptEvent</span><span class="p">.</span><span class="nx">userChoice</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">choiceResult</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">choiceResult</span><span class="p">.</span><span class="nx">outcome</span> <span class="o">===</span> <span class="s1">'accepted'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'用户已经接受安装'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'用户已经取消安装'</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// 只能用一次</span>
      <span class="nx">installPromptEvent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div><h2 id="4-demo效果">4. demo效果</h2><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190530/2019-05-30 00.20.10.gif" alt="demo-a2hs" /></p><p><a href="https://github.com/wangjunneil/exchange-pwa/tree/master/src/views">完整的demo代码</a></p><h2 id="5-判断是否安装">5. 判断是否安装</h2><p>监听安装事件</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'appinstalled'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'installed'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p>若是从主屏幕启动，则可以通过 javascript 判断</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">matchMedia</span><span class="p">(</span><span class="s1">'(display-mode: standalone)'</span><span class="p">).</span><span class="nx">matches</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'display-mode is standalone'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>safari浏览器</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">standalone</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'display-mode is standalone'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><blockquote><p>这里需要注意的是，上面三个输出只会在 standalone 模式下执行</p></blockquote><h2 id="6-参考链接">6. 参考链接</h2><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps/Add_to_home_screen">Add to Home screen</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/BeforeInstallPromptEvent">Before​Install​Prompt​Event</a></li><li><a href="http://www.jomendez.com/2018/06/05/add-home-screen-pwas/">Add to Home Screen your ionic PWA</a></li></ul><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="https://www.wangjun.dev//2019/05/pwa-handle-install-prompt/" akt="">https://www.wangjun.dev//2019/05/pwa-handle-install-prompt/</a></div></blockquote><div class="divider"></div></article><div class="page-navigation"> <a class="next" href="/2019/06/https-certificate/" title="NEXT: 开源免费的 SSL 证书汇总">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">Home</a> <span> &middot; </span> <a class="prev" href="/2018/05/pwa-app/" title="PREV: Progressive Web App 汇总使用说明">&gt;&gt;</a></div><!-- 书签处理 --> <script type="text/javascript" src="/assets/js/zepto.min.js"></script> <script type="text/javascript" src="/assets/js/nav.js"></script></main><!-- service worker check update bar --><div id="notification">A new version of this app is available. Click <a id="reload">here</a> to update.</div></body></html>