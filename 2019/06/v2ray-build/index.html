<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- pwa meta begin --><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#000"><meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="msapplication-tap-highlight" content="no"> <!-- IOS不会读取manifest中的icon，用此配置进行适配 --><link rel="apple-touch-icon" href="assets/icons/icon-96x96.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/icons/icon-167x167.png"> <!-- ios修复splash黑屏 --><link href="/assets/img/icons/apple_splash_1125.png" sizes="1125x2436" rel="apple-touch-startup-image" /><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"> <!-- pwa meta end --><title>🔥 旅行必备 V2Ray 的高级使用方式</title><meta name="description" content=""><meta name="keywords" content="翻墙,ssr,ssl,v2ray,cdn,letsencrypt,出国"><link rel="icon" href="/assets/favicon.ico"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2019/06/v2ray-build/"><link rel="alternate" type="application/atom+xml" title="The Jun Wong's blog" href="/feed.xml" /></head><body> <!-- 全局页面loading --><div class="loading"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div><!-- search --><div class="searchform"> <a href="javascript:void(0);" class="searchicon"></a> <input type="text" id="keyword"/> <a href="javascript:void(0);" class="clear"></a><ul class="suggest"></ul></div><script src="/assets/js/jquery-1.9.1.min.js"></script> <script src="/assets/js/main.js"></script><nav class="header-nav"> <a class="page-link" href="/">HOME</a> / <a class="page-link" href="/categories/">CATEGORY</a> / <a class="page-link" href="/feed.xml">FEED</a> <!-- <a class="page-link" href="/lab/index.html">MYLAB</a> --> / <a class="page-link" href="/about/">ABOUT</a></nav><main><article> <!-- 目录导航，在nav,js中进行渲染 --><div class="w-catalog"></div><div class="w-catalog-btn">目录</div><div class="center"><h1>🔥 旅行必备 V2Ray 的高级使用方式</h1><time>2019-06-06</time></div><div class="divider"></div><ul id="markdown-toc"><li><a href="#1-介绍" id="markdown-toc-1-介绍">1. 介绍</a></li><li><a href="#2-安装和使用" id="markdown-toc-2-安装和使用">2. 安装和使用</a><ul><li><a href="#21-创建实例" id="markdown-toc-21-创建实例">2.1 创建实例</a></li><li><a href="#22-执行安装" id="markdown-toc-22-执行安装">2.2 执行安装</a></li><li><a href="#23-配置文件" id="markdown-toc-23-配置文件">2.3 配置文件</a></li><li><a href="#24-重启服务" id="markdown-toc-24-重启服务">2.4 重启服务</a></li><li><a href="#25-配置连接" id="markdown-toc-25-配置连接">2.5 配置连接</a></li></ul></li><li><a href="#3-欺骗与伪装" id="markdown-toc-3-欺骗与伪装">3. 欺骗与伪装</a><ul><li><a href="#31-整体方案" id="markdown-toc-31-整体方案">3.1 整体方案</a></li><li><a href="#32-安装nginx" id="markdown-toc-32-安装nginx">3.2 安装nginx</a></li><li><a href="#33-域名解析" id="markdown-toc-33-域名解析">3.3 域名解析</a></li><li><a href="#34-安全证书" id="markdown-toc-34-安全证书">3.4 安全证书</a></li><li><a href="#35-隐藏地址" id="markdown-toc-35-隐藏地址">3.5 隐藏地址</a></li><li><a href="#36-配置v2ray" id="markdown-toc-36-配置v2ray">3.6 配置v2ray</a></li><li><a href="#37-代理转发" id="markdown-toc-37-代理转发">3.7 代理转发</a></li><li><a href="#38-配置连接" id="markdown-toc-38-配置连接">3.8 配置连接</a></li></ul></li><li><a href="#完整的配置" id="markdown-toc-完整的配置">完整的配置</a></li></ul><h2 id="1-介绍">1. 介绍</h2><p><a href="//www.v2ray.com/">V2Ray</a> 是一个与 Shadowsocks 类似的代理软件，很多人可能会想当然地将 V2Ray 看作一个特定的翻墙协议或用于实现该协议的翻墙软件。但实际上是一个融合了各种翻墙协议的集成性软件，其中只有 VMess 协议是 V2Ray 社区原创的翻墙协议。</p><h2 id="2-安装和使用">2. 安装和使用</h2><h3 id="21-创建实例">2.1 创建实例</h3><p>参考 <a href="//wangjun.dev/2019/06/ssr-build/">旅行必备 ShadowsocketR 搭建与使用</a> 中的创建实例</p><blockquote><p>唯一区别就是建议将CPU设置为”n1标准型”</p></blockquote><h3 id="22-执行安装">2.2 执行安装</h3><p>打开 vm 实例的 ssh 终端，输入以下命令执行安装：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 切换成root用户</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>

<span class="c"># 同步本地时间</span>
<span class="nv">$ </span><span class="nb">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

<span class="c"># 执行一键安装脚本</span>
<span class="nv">$ </span>bash &lt;<span class="o">(</span>curl <span class="nt">-L</span> <span class="nt">-s</span> https://install.direct/go.sh<span class="o">)</span>
</code></pre></div></div><p>终端显示”V2Ray v4.19.1 is installed.”，表示已经安装完成。</p><h3 id="23-配置文件">2.3 配置文件</h3><p>点击下载 <a href="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/config.json">config.json</a> 配置文件，修改 port、id、alterId 字段，id和alterId随意变更，保持位数一致。port 最好使用已经配置好防火墙规则的端口（关于配置防火墙规则请参看 <a href="//wangjun.dev/2019/06/ssr-build/">旅行必备 ShadowsocketR 搭建与使用</a> 中的配置防火墙一节）。</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/v2ray-config-json.png" alt="v2ray-config-json" /></p><p>准备好 v2ray 的配置内容后，到刚才创建的实例中，使用命令<code class="highlighter-rouge">vi /etc/v2ray/config.json</code>打开v2ray的配置文件，删除里面全部内容，将准备好的配置明细复制进去，复制的格式很乱，不需要关心，v2ray会正常解析</p><blockquote><p>小技巧，vi编辑器中使用命令 :set paste 打开粘贴模式可以保证格式</p></blockquote><h3 id="24-重启服务">2.4 重启服务</h3><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 重新启动v2ray服务</span>
<span class="nv">$ </span>systemctl restart v2ray

<span class="c"># 查询启动后服务状态</span>
<span class="nv">$ </span>systemctl status v2ray

<span class="c"># 将v2ray服务注册为开机自自动</span>
<span class="nv">$ </span>systemctl <span class="nb">enable </span>v2ray
</code></pre></div></div><h3 id="25-配置连接">2.5 配置连接</h3><p>点击下载 <a href="//github.com/Cenmrev/V2RayX/releases">v2ray</a> 客户端并安装。</p><p>所有配置在上面的json中都可以找到，配置如下：</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/v2ray-client.png" alt="v2ray-client" /></p><p>配置完成并save后，点击load core即可开启国际旅行</p><h2 id="3-欺骗与伪装">3. 欺骗与伪装</h2><p>上面的配置方式是直连 v2ray 服务端，虽然使用的是 vmes 协议这种冷门协议，尽管也对传输体进行了aes的加密，但不排除伟大的墙会找到协议的特征码进行block，为了达到极致效果，基于上述继续我们的升级计划。</p><h3 id="31-整体方案">3.1 整体方案</h3><p>[v2ray + websocket + tls + nginx + cdn]</p><p>此处应有图，懒的画了，自己理解。</p><h3 id="32-安装nginx">3.2 安装nginx</h3><p>继续在上面的服务器中执行以下命令安装nginx反向代理服务器（这也是为什么在第一步要求CPU稍微高点的原因，毕竟需要安装两个服务，不能使用微型CPU配置）</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 切换成root用户</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>

<span class="c"># 安装nginx服务</span>
<span class="nv">$ </span>apt <span class="nb">install </span>nginx
</code></pre></div></div><p>安装完成后，默认nginx就已经启动，可以使用命令<code class="highlighter-rouge">netstat -an | grep 80</code>看看端口是否处于 listen 状态，打开浏览器，直接输入服务器的IP地址应该可以看到nginx的欢迎界面，如下：</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/nginx.png" alt="nginx" /></p><h3 id="33-域名解析">3.3 域名解析</h3><p>这里使用在阿里云注册的域名为例，如果没有的话，可以在 <a href="https://www.freenom.com/zh/index.html?lang=zh">freenom</a> 可以申请免费域名。将域名解析到上面服务器的公网IP上，添加一个记录，记录类型为A，主机记录为ray，这样就将二级域名 ray.wangjun.bid 解析到了对应的 Google 云服务器上。</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/aliyun-parse.png" alt="aliyun-parse" /></p><p>到服务器上使用命令<code class="highlighter-rouge">vi /etc/nginx/sites-available/default</code>打开nginx配置文件，删除里面所有内容，将域名配置到nginx的配置文件中，最终内容如下：</p><div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> {
    <span class="n">listen</span> <span class="m">80</span> <span class="n">default_server</span>;
    <span class="n">listen</span> [::]:<span class="m">80</span> <span class="n">default_server</span>;

    <span class="n">root</span> /<span class="n">var</span>/<span class="n">www</span>/<span class="n">html</span>;
    <span class="n">index</span> <span class="n">index</span>.<span class="n">html</span> <span class="n">index</span>.<span class="n">htm</span> <span class="n">index</span>.<span class="n">nginx</span>-<span class="n">debian</span>.<span class="n">html</span>;

    <span class="c"># 这里使用自己定义的域名
</span>    <span class="n">server_name</span> <span class="n">ray</span>.<span class="n">wangjun</span>.<span class="n">bid</span>;

    <span class="n">location</span> / {
        <span class="n">try_files</span> $<span class="n">uri</span> $<span class="n">uri</span>/ =<span class="m">404</span>;
    }
}
</code></pre></div></div><p>保存配置，并在终端中使用命令<code class="highlighter-rouge">nginx -s reload</code>让nginx重新加载配置，若没有任何信息输出表示配置正确，重新打开浏览器使用域名访问应能正常显示nginx的欢迎页面，说明域名解析成功。</p><h3 id="34-安全证书">3.4 安全证书</h3><p>上面的输出说明我们正常解析了域名，但80端口的HTTP协议是明文传输的，我们需要在HTTP协议上层在加上TLS的HTTPS协议，使传输内容加密。</p><p>要为站点申请HTTPs证书，可以使用 <a href="https://letsencrypt.org/">letsencrypt</a> 机构颁发的免费证书，省钱又可靠，letsencrypt 有个工具 <a href="https://certbot.eff.org">certbot</a>，全自动生成证书，下面是使用方法。</p><p>系统版本和代理服务器安装方式不一样，根据自己的配置来，这里在 Google 云创建的是 debian9 的操作系统，代理服务器使用的是 nginx，所以：</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/certboot.png" alt="certboot" /></p><p>那我们的安装方式就是：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 切换成root用户</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>

<span class="c"># 安装certbot及其依赖</span>
<span class="nv">$ </span>apt-get <span class="nb">install </span>certbot python-certbot-nginx <span class="nt">-t</span> stretch-backports
</code></pre></div></div><p>颁发证书</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>certbot <span class="nt">--nginx</span>
</code></pre></div></div><p>这里会要求输入和选择几项配置，具体如下：</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/publish-cert.png" alt="publish-cert" /></p><p>出现”Congratulations”说明命令执行成功，重新打开浏览器输入<strong>https://域名</strong>可以正常看见nginx欢迎界面，且浏览器网址左边的小锁正常显示，HTTPS配置完成。</p><table><tbody><tr><td>letsencrypt 为我们颁发的HTTPs证书有效期是90天，90天后证书会失效，可以使用命令<code class="highlighter-rouge">certbot renew --dry-run</code>重新颁发一次，当然最好在cron中配置好定时任务来自动执行</td></tr></tbody></table><h3 id="35-隐藏地址">3.5 隐藏地址</h3><p>Ping域名可以得到真实的服务器地址，尽管可以禁ping命令，但仍有很多工具可以发现我们在 Google 云上真实的服务器IP，这里使用CDN让域名指向地址变得隐藏，尽管这不是绝对的，但仍能杜绝大部分想获取服务器IP的方法。</p><p>CDN同样我们选择免费的，免费即王道，这里选择 <a href="https://www.cloudflare.com/zh-cn/">CloudFlare</a>，具体操作如下：</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/CloudFlare-addsite.png" alt="CloudFlare-addsite" /></p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/CloudFlare-freeplan.png" alt="CloudFlare-freeplan" /></p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/CloudFlare-parse.png" alt="CloudFlare-parse" /></p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/CloudFlare-dns.png" alt="CloudFlare-dns" /></p><p>经过上面的操作，CloudFlare配置已经完成，最后在阿里云域名下将对应域名的 DNS 解析为 CloudFlare 为我们分配的 DNS 记录，点击确定即可</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/aliyun-edit-dns.png" alt="aliyun-edit-dns" /></p><p>CDN已经配置完成</p><h3 id="36-配置v2ray">3.6 配置v2ray</h3><p>我们上面的操作都与v2ray没有任何关系，只是创建了一个普通的HTTPS的静态站点，现在我们这才开始将其关联。</p><p>编辑<code class="highlighter-rouge">vi /etc/v2ray/config.json</code>文件修改和新增如下配置</p><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190605/v2ray-config-update.png" alt="v2ray-config-update" /></p><p>这里为什么改端口，之前的端口已经配置在防火墙的出入站规则中，外部是可以直接访问，反向代理一个重要的原则是隐藏内部应用，统一出入口，所以端口只需要设置一个不在防火墙规则里的1024～65535之间的值即可。</p><p>重新启动v2ray并查看启动状态</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl restart v2ray
<span class="nv">$ </span>systemctl status v2ray
</code></pre></div></div><p>一切正常，恭喜你，你已经不能使用 v2ray 服务了，因为目前 v2ray 服务只是在服务器内部启动，并没有对外开放，只能服务器内部访问，如果暴露 v2ray 服务，这是下一步做的事情。</p><h3 id="37-代理转发">3.7 代理转发</h3><p>编辑nginx配置文件<code class="highlighter-rouge">vi /etc/nginx/sites-available/default</code>，内容有些乱，是因为在使用certbot生成HTTPS证书时自动改的，不管，直接使用复制下面在nginx的配置，配置v2ray的反向代理，最终结果如下：</p><div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> {
    <span class="n">listen</span> [::]:<span class="m">443</span> <span class="n">ssl</span> <span class="n">ipv6only</span>=<span class="n">on</span>;
    <span class="n">listen</span> <span class="m">443</span> <span class="n">ssl</span>;

    <span class="c"># 这里填写自己的证书路径
</span>    <span class="n">ssl_certificate</span> /<span class="n">etc</span>/<span class="n">letsencrypt</span>/<span class="n">live</span>/<span class="n">ray</span>.<span class="n">wangjun</span>.<span class="n">bid</span>/<span class="n">fullchain</span>.<span class="n">pem</span>;
    <span class="n">ssl_certificate_key</span> /<span class="n">etc</span>/<span class="n">letsencrypt</span>/<span class="n">live</span>/<span class="n">ray</span>.<span class="n">wangjun</span>.<span class="n">bid</span>/<span class="n">privkey</span>.<span class="n">pem</span>;
    
    <span class="n">include</span> /<span class="n">etc</span>/<span class="n">letsencrypt</span>/<span class="n">options</span>-<span class="n">ssl</span>-<span class="n">nginx</span>.<span class="n">conf</span>;
    <span class="n">ssl_dhparam</span> /<span class="n">etc</span>/<span class="n">letsencrypt</span>/<span class="n">ssl</span>-<span class="n">dhparams</span>.<span class="n">pem</span>;

    <span class="n">root</span> /<span class="n">var</span>/<span class="n">www</span>/<span class="n">html</span>;
    <span class="n">index</span> <span class="n">index</span>.<span class="n">html</span> <span class="n">index</span>.<span class="n">htm</span> <span class="n">index</span>.<span class="n">nginx</span>-<span class="n">debian</span>.<span class="n">html</span>;

    <span class="c"># 这里填写自己的域名
</span>    <span class="n">server_name</span> <span class="n">ray</span>.<span class="n">wangjun</span>.<span class="n">bid</span>;

    <span class="n">location</span> / {
        <span class="n">try_files</span> $<span class="n">uri</span> $<span class="n">uri</span>/ =<span class="m">404</span>;
    }

    <span class="c"># ========== 增加的配置 ========== 
</span>    <span class="c"># 请求"/ray"与v2ray配置里的wsSettings下path对齐
</span>    <span class="n">location</span> /<span class="n">ray</span> {            
        <span class="c"># 转发地址与v2ray配置里的listen和port对齐
</span>        <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>:<span class="m">9001</span>;

        <span class="n">proxy_redirect</span> <span class="n">off</span>;
        <span class="n">proxy_http_version</span> <span class="m">1</span>.<span class="m">1</span>;
        <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> $<span class="n">http_upgrade</span>;
        <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s2">"upgrade"</span>;
        <span class="n">proxy_set_header</span> <span class="n">Host</span> $<span class="n">http_host</span>;
    }
}
</code></pre></div></div><p>执行命令让nginx重新加载配置文件，没输出表示配置OK</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ngins <span class="nt">-s</span> reload
</code></pre></div></div><p>解释下上面的配置，当使用”https://域名/ray”访问时，nginx将所有请求代理转发到内部应用127.0.0.1:9001上，而这个启动着9001端口的内部应用就是v2ray服务，这样就像正常访问普通站点一样完成我们伟大的出国旅行计划，出关被检查时，GF认为请求的是正常的网页服务从而达到伪装的目的，下面配置v2ray客户端。</p><h3 id="38-配置连接">3.8 配置连接</h3><p>使用伪装欺骗的方式旅行，客户端上的配置与普通的稍有区别，具体如下：</p><ol><li>更改Address和端口号，network协议改成ws，其他保持不变，然后点击transport settings按钮</li><li>path值改为/ray</li><li>勾选Use TLS，TLS serverName使用配置的域名</li></ol><p><img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190606/v2ray-client-fake-1.png" alt="v2ray-client-fake-1" /> <img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190606/v2ray-client-fake-2.png" alt="v2ray-client-fake-2" /> <img src="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190606/v2ray-client-fake-3.png" alt="v2ray-client-fake-3" /></p><p><strong>All done.</strong> 点击客户端上的load core，✈️ 开启你的环游世界之旅。</p><h2 id="完整的配置">完整的配置</h2><p>最后奉上v2ray和nginx完整的配置文件，仅供参考。</p><ul><li>nginx，<a href="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190606/default_full">点击下载</a></li><li>v2ray，<a href="//vinnycc.oss-cn-shanghai.aliyuncs.com/20190606/config_full.json">点击下载</a></li></ul><div class="divider"></div><blockquote id='by-nc-nd'><div> 版权所有，本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">知识共享署名-非商业性使用 3.0 未本地化版本许可协议</a>进行许可。转载请注明出处：<a href="https://www.wangjun.dev//2019/06/v2ray-build/" akt="">https://www.wangjun.dev//2019/06/v2ray-build/</a></div></blockquote><div class="divider"></div></article><div class="page-navigation"> <a class="home" href="/" title="Back to Homepage">Home</a> <span> &middot; </span> <a class="prev" href="/2019/06/outline-build/" title="PREV: 旅行必备 Outline 搭建与使用">&gt;&gt;</a></div><!-- 书签处理 --> <script type="text/javascript" src="/assets/js/zepto.min.js"></script> <script type="text/javascript" src="/assets/js/nav.js"></script></main><!-- service worker check update bar --><div id="notification">A new version of this app is available. Click <a id="reload">here</a> to update.</div></body></html>