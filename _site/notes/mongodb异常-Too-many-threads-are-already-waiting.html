<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Mongodb异常"too many threads are already waiting"</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@HeiswayiNrird" /><meta name="twitter:title" content="Mongodb异常"too many threads are already waiting"" /><meta name="twitter:description" content="在使用 java 操作 mongodb 时，出现了以下的异常信息："><meta name="description" content="在使用 java 操作 mongodb 时，出现了以下的异常信息："><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.ico"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link href="https://fonts.googleapis.com/css?family=Karla" rel="stylesheet"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/mongodb%E5%BC%82%E5%B8%B8-Too-many-threads-are-already-waiting"><link rel="alternate" type="application/atom+xml" title="A Coder, a Programmer, a Hacker walk into Evan's Blog" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="/assets/evan.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Mongodb异常"too many threads are already waiting"</h1><time>September 6, 2016</time></div><div class="divider"></div><p>在使用 <code class="highlighter-rouge">java</code> 操作 <strong>mongodb</strong> 时，出现了以下的异常信息：</p><div class="highlighter-rouge"><pre class="highlight"><code>nested exception is com.mongodb.MongoWaitQueueFullException: Too many threads are already waiting for a connection. Max number of threads (maxWaitQueueSize) of 50 has been exceeded.
</code></pre></div><p>由上面的日志看出此类异常并不是发生在 <strong>Spring</strong> 中，而是发生在 <strong>mongodb</strong> 中，所以无论是否集成 <strong>Spring</strong> 或者单独使用 <strong>MongoClient</strong> 都有可能出现此错误。这个异常的原因在于 <strong>mongodb</strong> 的连接线程数不够使用，导致下面的客户端获取不到连接而抛出了队列等待线程数已满的错误，解决方法如下：</p><h1 id="单独使用mongoclient对象">单独使用MongoClient对象</h1><div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="err">#</span> <span class="err">设置属性</span><span class="n">connectionsPerHost</span>
<span class="n">MongoClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MongoClient</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span><span class="n">MongoClientOptions</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">connectionsPerHost</span><span class="o">(</span><span class="mi">250</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</code></pre></div><h1 id="集成spring时的设置">集成spring时的设置</h1><div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="c">&lt;!-- spring 4新版本中 --&gt;</span>
<span class="nt">&lt;mongo:mongo</span> <span class="na">host=</span><span class="s">"${mongo.db.host}"</span> <span class="na">port=</span><span class="s">"${mongo.db.port}"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- 设置属性connectionsPerHost --&gt;</span>
    <span class="nt">&lt;mongo:options</span> <span class="na">connections-per-host=</span><span class="s">"100"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/mongo:mongo&gt;</span>
 
<span class="c">&lt;!-- spring 旧版本中 --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"options"</span> <span class="na">class=</span><span class="s">"com.mongodb.MongoOptions"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionsPerHost"</span> <span class="na">value=</span><span class="s">"${mongo.db.pool.size}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxWaitTime"</span> <span class="na">value=</span><span class="s">"${mongo.db.pool.maxwait}"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"address"</span> <span class="na">class=</span><span class="s">"com.mongodb.ServerAddress"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"host"</span> <span class="na">value=</span><span class="s">"${mongo.db.host}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"port"</span> <span class="na">value=</span><span class="s">"${mongo.db.port}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"mongo"</span> <span class="na">class=</span><span class="s">"com.mongodb.Mongo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"addr"</span> <span class="na">ref=</span><span class="s">"address"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"options"</span> <span class="na">ref=</span><span class="s">"options"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"mongoTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.data.mongodb.core.MongoTemplate"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">"mongo"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"databaseName"</span> <span class="na">value=</span><span class="s">"${mongo.db.name}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></article><div class="page-navigation"> <a class="next" href="/notes/jdk1.8%E4%B8%AD%E6%B5%81stream%E7%9A%84%E5%A4%84%E7%90%86-%E9%81%8D%E5%8E%86-%E8%81%9A%E5%90%88%E7%AD%89%E7%A4%BA%E4%BE%8B%E6%93%8D%E4%BD%9C" title="NEXT: Jdk1.8中流stream的处理、遍历、聚合等示例操作">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="/" title="Back to Homepage">首页</a></div></main><div class="footer"> <!-- <span class="block">Made with &hearts; using <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="https://github.com/heiswayi/the-plain" title="The Plain theme by Heiswayi Nrird">The Plain</a> &middot; &lt;/&gt; on <a href="https://github.com/wangjunneil" title="Hosted on GitHub">GitHub</a></span> --> <span class="block"><a href="https://wangjunneil.github.io">Evan's Blog</a> © 2016 - All Rights Reserved</span></div></body></html>